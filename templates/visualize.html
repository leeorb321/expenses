{% extends "layout.html" %}
{% block title %}Visualize Data{% endblock %}
{% block content %}

  <script type="text/javascript" src="{{ url_for('static', filename='expenses_charts.js') }}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.min.js"></script>

  <script type="text/javascript">
    function reloadStylesheets() {
      var queryString = '?reload=' + new Date().getTime();
      $('link[rel="stylesheet"]').each(function () {
          this.href = this.href.replace(/\?.*|$/, queryString);
      });
    }
  </script>

  <div class="page">
  <h1>Visualize Data</h1>

    <div id="chart-options">
      <div class="form-group">

        <div class="row">

          <div class="col-md-5 col-md-offset-1">
            <label>Chart Type:</label>
            <select name="chart_type" class="form-control">
              <option value="pie">Pie</option>
              <option value="bar">Bar</option>
              <option value="line">Line</option>
            </select>
          </div>

          <div class="col-md-6 dropdown">
            <label>Display By:</label><br>
            <select name="display">
              <option value="category" selected="selected">Category</option>
              <option value="person">Person</option>
              <option value="year">Year</option>
              <option value="month">Month</option>
              <option value="week">Week</option>
              <option value="day">Day</option>
            </select>
          </div>

        </div>
        <br>

        <div class="row">

          <div class="col-md-5 col-md-offset-1">
            <label>Start Date:</label>
            <input type="date" name="date_from" class="form-control">
          </div>

          <div class="col-md-6">
            <label>End Date:</label>
            <input type="date" name="date_to" class="form-control">
          </div>

        </div>
        <br>

        <div id="filter_rows">
          <div class="row filter_row" id="row1">

            <div class="col-md-1">
              <br><br>
              <p>
              <button id="more_data_button">+</button>
              </p>
            </div>

            <div class="col-md-5">
              <label>Categories:</label><br>
              <select name="categories_chosen" multiple>
                {% for category in categories%}
                  <option value="{{ category }}">{{ category.capitalize() }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label>Persons:</label><br>
              <select name="persons_chosen" multiple>
                {% for person in persons%}
                  <option value="{{ person }}">{{ person.capitalize() }}</option>
                {% endfor %}
              </select>
            </div>

          </div>
        </div>

        <div class="row">
          <div class="col-md-4 col-md-offset-8">
            <br>
            <button class="btn btn-primary" id="submit-button">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <div id="canvas-container">
      <canvas id="all-data" width="600" height="400"></canvas>
    </div>

    <script type="text/javascript">
        var canvas = document.getElementById("all-data").getContext("2d");

        var aggregatedData = {{data|tojson}};
        var categories = {{categories|tojson}};
        var persons = {{persons|tojson}};

        for (var i = 0; i < aggregatedData.length; i++) {
          aggregatedData[i].date = new Date(aggregatedData[i].date);
        }

        var mainChart = drawCharts(aggregatedData, "{{chartType}}", "{{dateFrom}}", "{{dateTo}}", {{categoriesSelected|tojson}}, {{personsSelected|tojson}}, "{{display}}");

        $("#submit-button").on("click", function() {
            updateCharts(aggregatedData, categories, persons, mainChart);
        });

        $(document).ready(function() {
          $("select[name='categories_chosen']").multiselect();
          $("select[name='persons_chosen']").multiselect();
          $("select[name='display']").multiselect();
        });

        function upperCaseFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // $("#more_data_button").on("click", function() {
        //   // APPEND HTML
        //   var last_row_selector = $(".filter_row").last();
        //   var new_row_id = parseInt(last_row_selector.attr("id").replace("row", ""));
        //   new_row_id++;

        //   var categories_str = "";
        //   for (var i = 0; i < categories.length; i++) {
        //     categories_str += "<option value=" + categories[i] + ">" + upperCaseFirstLetter(categories[i]) + "</option>";
        //   }

        //   var persons_str = "";
        //   for (var i = 0; i < persons.length; i++) {
        //     persons_str += "<option value=" + persons[i] + ">" + upperCaseFirstLetter(persons[i]) + "</option>";
        //   }

        //   $("#filter_rows").append(


        //   '<div class="row filter_row" id="row'+new_row_id+'"><div class="col-md-1">' +
        //   '<br><br><p><button id="more_data_button">+</button></p></div>' +
        //   '<div class="col-md-5"><label>Categories:</label><br><select name="categories_chosen" multiple>' +
        //   categories_str + '</select></div><div class="col-md-6"><label>Persons:</label><br>' +
        //   '<select name="persons_chosen" multiple>' + persons_str + '</select></div></div>'

        //   );

        //   // REMOVE LAST + BUTTON AFTER ADDING ROW

        // });

    </script>

  </div>


{% endblock %}
